<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentum - To-Do List & Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-card {
            touch-action: pan-y;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Animation for task detail panel */
        #task-detail-panel.translate-x-full {
            transform: translateX(100%);
        }
        /* Drag and drop styling */
        .dragging {
            opacity: 0.5;
            background: #e0e7ff;
        }
        .dark .dragging {
            background: #312e81;
        }
        .drag-over {
            border: 2px dashed #4f46e5;
        }
        .dark .drag-over {
            border: 2px dashed #a5b4fc;
        }
        /* Simple pulse animation for AI buttons */
        .ai-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div id="app-container" class="flex h-screen w-full overflow-hidden">

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-white dark:bg-slate-800 w-64 p-4 flex-shrink-0 flex flex-col transition-all duration-300 -translate-x-full sm:translate-x-0 absolute sm:relative z-20 h-full">
            <div class="flex items-center mb-6">
                <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
                <h1 class="text-2xl font-bold ml-2">Momentum</h1>
            </div>

            <!-- Main Navigation -->
            <nav class="flex-grow">
                <ul>
                    <li><a href="#" id="nav-today" class="flex items-center p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium bg-slate-100 dark:bg-slate-700">
                        <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Today
                    </a></li>
                </ul>

                <h2 class="text-xs font-bold uppercase text-slate-400 dark:text-slate-500 mt-6 mb-2 px-2">Projects</h2>
                <ul id="project-list" class="space-y-1">
                    <!-- Projects will be dynamically inserted here -->
                </ul>
                <button id="add-project-btn" class="w-full text-left flex items-center p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 mt-2">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    New Project
                </button>
            </nav>
            
            <!-- User Info and Settings -->
            <div class="mt-auto">
                 <div class="text-xs text-slate-400 mb-2 truncate">User ID: <span id="user-id-display">Loading...</span></div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-slate-200 dark:bg-slate-700">
                        <span id="theme-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 sm:bg-transparent sm:dark:bg-transparent">
                <div>
                     <button id="sidebar-toggle" class="sm:hidden p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 mr-2">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="view-title" class="text-2xl font-bold inline-block">Today</h2>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="smart-add-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center ai-pulse">
                        <svg class="h-5 w-5 mr-0 sm:mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        <span class="hidden sm:inline">AI Add</span>
                    </button>
                    <div id="view-switcher" class="hidden sm:flex items-center bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                        <button data-view="list" class="view-btn active px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow">List</button>
                        <button data-view="board" class="view-btn px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400">Board</button>
                    </div>
                    <button id="add-task-main-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <svg class="h-5 w-5 mr-0 sm:mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span class="hidden sm:inline">New Task</span>
                    </button>
                </div>
            </header>

            <!-- Task Views Container -->
            <div id="task-views-container" class="flex-1 overflow-y-auto p-4 sm:p-6">
                <!-- List View -->
                <div id="list-view" class="space-y-3">
                    <!-- Task items will be dynamically inserted here -->
                </div>

                <!-- Board View -->
                <div id="board-view" class="hidden h-full">
                    <div class="flex space-x-4 h-full overflow-x-auto pb-4">
                        <div class="board-column w-72 flex-shrink-0 bg-slate-100 dark:bg-slate-800 rounded-lg p-3">
                            <h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300">To-Do</h3>
                            <div class="task-list space-y-3 min-h-[100px]" data-status="todo"></div>
                        </div>
                        <div class="board-column w-72 flex-shrink-0 bg-slate-100 dark:bg-slate-800 rounded-lg p-3">
                            <h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300">In Progress</h3>
                            <div class="task-list space-y-3 min-h-[100px]" data-status="inprogress"></div>
                        </div>
                        <div class="board-column w-72 flex-shrink-0 bg-slate-100 dark:bg-slate-800 rounded-lg p-3">
                            <h3 class="font-bold mb-3 text-slate-700 dark:text-slate-300">Done</h3>
                            <div class="task-list space-y-3 min-h-[100px]" data-status="done"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Task Detail Panel -->
        <aside id="task-detail-panel" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 shadow-lg z-30 transform translate-x-full transition-transform duration-300 ease-in-out p-6 flex flex-col">
             <!-- Panel content will be dynamically inserted here -->
        </aside>

    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="text-white text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4">AI is thinking...</p>
        </div>
    </div>


    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="task-modal-title" class="text-xl font-bold mb-4">New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Title</label>
                    <input type="text" id="task-title" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="task-description" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Description</label>
                    <textarea id="task-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-project" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Project</label>
                        <select id="task-project" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Priority</label>
                        <select id="task-priority" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                 <div class="mb-6">
                    <label for="task-due-date" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Due Date</label>
                    <input type="date" id="task-due-date" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Smart Add Modal -->
    <div id="smart-add-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex items-center mb-4">
                 <svg class="h-6 w-6 mr-3 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <h2 class="text-xl font-bold">AI Smart Add</h2>
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Describe a goal, and AI will break it down into a project and tasks for you. <br>Example: "Plan a team offsite event for Q3"</p>
            <form id="smart-add-form">
                <div class="mb-4">
                    <textarea id="smart-add-prompt" rows="4" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500" placeholder="Type your goal here..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-smart-add-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Generate Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="project-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">New Project</h2>
            <form id="project-form">
                <div class="mb-4">
                    <label for="project-name" class="block text-sm font-medium text-slate-600 dark:text-slate-300">Project Name</label>
                    <input type="text" id="project-name" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-project-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Add Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirm-title" class="text-lg font-bold mb-2">Are you sure?</h2>
            <p id="confirm-message" class="text-sm text-slate-600 dark:text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, getDocs, onSnapshot, 
            updateDoc, deleteDoc, query, where, setLogLevel, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'momentum-todo-app';
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) {
            console.error("Firebase config is not valid JSON", e);
            firebaseConfig = {};
        }

        // --- DOM Elements ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleIndicator = document.getElementById('theme-toggle-indicator');
        const taskModal = document.getElementById('task-modal');
        const smartAddModal = document.getElementById('smart-add-modal');
        const projectModal = document.getElementById('project-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const loaderOverlay = document.getElementById('loader-overlay');
        const taskForm = document.getElementById('task-form');
        const smartAddForm = document.getElementById('smart-add-form');
        const projectForm = document.getElementById('project-form');
        const taskDetailPanel = document.getElementById('task-detail-panel');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- App State ---
        let appState = {
            tasks: [],
            projects: [],
            currentView: 'list', // 'list' or 'board'
            currentFilter: { type: 'today', id: null },
            activeTask: null,
            db: null,
            auth: null,
            userId: null,
            isAuthReady: false,
            projectUnsubscribe: () => {},
            taskUnsubscribe: () => {},
        };
        
        // --- Gemini API ---
        const GEMINI_API_KEY = ""; // Kept empty as per instructions
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        
        async function callGeminiAPI(systemPrompt, userPrompt) {
            showLoader();
            try {
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("Invalid response structure from API");
                }

                // Clean the response to get valid JSON
                const jsonString = text.match(/```json\n([\s\S]*?)\n```/)?.[1] || text;
                return JSON.parse(jsonString);

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                // You can add a user-facing error message here
                return null;
            } finally {
                hideLoader();
            }
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                appState.db = getFirestore(app);
                appState.auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(appState.auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        appState.userId = user.uid;
                        appState.isAuthReady = true;
                        userIdDisplay.textContent = appState.userId;
                        fetchData();
                    } else {
                        console.log("User is signed out.");
                        appState.isAuthReady = false;
                        appState.userId = null;
                        userIdDisplay.textContent = 'Not signed in';
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(appState.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(appState.auth);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.body.innerHTML = '<div class="p-8 text-red-500">Error initializing the application. Please check your Firebase configuration.</div>';
            }
        }

        // --- Data Fetching ---
        function fetchData() {
            if (!appState.isAuthReady || !appState.userId) return;

            // Unsubscribe from previous listeners
            appState.projectUnsubscribe();
            appState.taskUnsubscribe();

            const projectCollectionPath = `artifacts/${appId}/users/${appState.userId}/projects`;
            const projectQuery = collection(appState.db, projectCollectionPath);

            appState.projectUnsubscribe = onSnapshot(projectQuery, (snapshot) => {
                appState.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects();
                renderTaskProjectDropdown();
            }, (error) => console.error("Error fetching projects:", error));
            
            const taskCollectionPath = `artifacts/${appId}/users/${appState.userId}/tasks`;
            const taskQuery = collection(appState.db, taskCollectionPath);

            appState.taskUnsubscribe = onSnapshot(taskQuery, (snapshot) => {
                appState.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Error fetching tasks:", error));
        }

        // --- Rendering ---
        function render() {
            if (!appState.isAuthReady) return;
            const filteredTasks = getFilteredTasks();
            renderTasks(filteredTasks);
            renderViewSwitcher();
            renderNavigation();
            if (appState.activeTask) {
                const updatedTask = appState.tasks.find(t => t.id === appState.activeTask.id);
                if (updatedTask) {
                    appState.activeTask = updatedTask;
                    renderTaskDetail(appState.activeTask);
                } else {
                    closeTaskDetailPanel();
                }
            }
        }

        function renderTasks(tasks) {
            const listView = document.getElementById('list-view');
            const boardView = document.getElementById('board-view');
            
            if (appState.currentView === 'list') {
                listView.classList.remove('hidden');
                boardView.classList.add('hidden');
                listView.innerHTML = tasks.length > 0 ? tasks.map(createTaskElement).join('') : getEmptyStateMessage();
            } else { // board view
                listView.classList.add('hidden');
                boardView.classList.remove('hidden');
                const todoList = boardView.querySelector('[data-status="todo"]');
                const inprogressList = boardView.querySelector('[data-status="inprogress"]');
                const doneList = boardView.querySelector('[data-status="done"]');

                todoList.innerHTML = tasks.filter(t => t.status === 'todo').map(createTaskCardElement).join('');
                inprogressList.innerHTML = tasks.filter(t => t.status === 'inprogress').map(createTaskCardElement).join('');
                doneList.innerHTML = tasks.filter(t => t.status === 'done').map(createTaskCardElement).join('');
                 if(tasks.length === 0){
                    todoList.innerHTML = getEmptyStateMessage();
                    inprogressList.innerHTML = "";
                    doneList.innerHTML = "";
                }
            }
            
            addDragAndDropListeners();
        }

        function getEmptyStateMessage() {
            return `<div class="text-center py-10">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 8h.01M12 12h.01M15 12h.01M9 16h6" /></svg>
                <h3 class="mt-2 text-sm font-medium text-slate-900 dark:text-white">No tasks yet</h3>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Get started by creating a new task.</p>
            </div>`;
        }
        
        function renderProjects() {
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = appState.projects.map(project => `
                <li class="project-item-container" data-project-id="${project.id}">
                    <a href="#" class="project-nav-link flex items-center justify-between p-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium">
                        <span class="truncate">${project.name}</span>
                        <button class="delete-project-btn hidden p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-800 text-slate-400 hover:text-red-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </a>
                </li>
            `).join('');
            
            document.querySelectorAll('.project-item-container').forEach(item => {
                item.addEventListener('mouseenter', () => item.querySelector('.delete-project-btn')?.classList.remove('hidden'));
                item.addEventListener('mouseleave', () => item.querySelector('.delete-project-btn')?.classList.add('hidden'));
            });
        }
        
        function renderTaskProjectDropdown() {
            const projectDropdown = document.getElementById('task-project');
            projectDropdown.innerHTML = `<option value="">No Project</option>` + 
                appState.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
        
        function renderViewSwitcher() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                if (btn.dataset.view === appState.currentView) {
                    btn.classList.add('active', 'bg-white', 'dark:bg-slate-600', 'shadow');
                    btn.classList.remove('text-slate-500', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('active', 'bg-white', 'dark:bg-slate-600', 'shadow');
                    btn.classList.add('text-slate-500', 'dark:text-slate-400');
                }
            });
        }
        
        function renderNavigation() {
            document.querySelectorAll('#sidebar nav a').forEach(el => {
                el.classList.remove('bg-slate-100', 'dark:bg-slate-700');
            });
            let activeEl;
            if (appState.currentFilter.type === 'today') {
                activeEl = document.getElementById('nav-today');
            } else if (appState.currentFilter.type === 'project') {
                activeEl = document.querySelector(`.project-nav-link[data-project-id="${appState.currentFilter.id}"]`);
            }
            if(activeEl) activeEl.classList.add('bg-slate-100', 'dark:bg-slate-700');
        }

        function renderTaskDetail(task) {
            const priorityColors = { low: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200', medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200', high: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'};
            const project = appState.projects.find(p => p.id === task.projectId);

            taskDetailPanel.innerHTML = `
                <div class="flex-shrink-0 flex items-start justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold">${task.title}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">in <strong>${project ? project.name : 'No Project'}</strong></p>
                    </div>
                    <button id="close-detail-panel" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="flex-grow overflow-y-auto pr-2 -mr-2">
                    <div class="space-y-6">
                        <div>
                            <label class="text-sm font-medium text-slate-500 dark:text-slate-400">Status</label>
                            <select id="detail-task-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To-Do</option>
                                <option value="inprogress" ${task.status === 'inprogress' ? 'selected' : ''}>In Progress</option>
                                <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                            </select>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Description</p>
                            <p class="mt-1">${task.description || 'No description provided.'}</p>
                        </div>
                        <div class="flex items-center space-x-8">
                           <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Due Date</p>
                                <p class="mt-1">${task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-CA') : 'No due date'}</p>
                            </div>
                             <div>
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Priority</p>
                                <span class="mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColors[task.priority]} capitalize">${task.priority}</span>
                            </div>
                        </div>
                        
                        <!-- AI Suggestions Section -->
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                            <button id="suggest-subtasks-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-purple-700 dark:text-purple-300 bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800">
                                <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                Suggest Sub-tasks
                            </button>
                            <div id="subtask-suggestions" class="mt-4 space-y-2"></div>
                        </div>

                    </div>
                </div>

                <div class="flex-shrink-0 border-t border-slate-200 dark:border-slate-700 pt-4 mt-6 flex items-center justify-between">
                    <span class="text-xs text-slate-400">Task ID: ${task.id}</span>
                    <div>
                        <button id="edit-task-detail-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 text-sm">Edit</button>
                        <button id="delete-task-detail-btn" class="px-4 py-2 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded-md hover:bg-red-200 dark:hover:bg-red-800 text-sm ml-2">Delete</button>
                    </div>
                </div>
            `;
            
            document.getElementById('close-detail-panel').addEventListener('click', closeTaskDetailPanel);
            document.getElementById('edit-task-detail-btn').addEventListener('click', () => openTaskModal(task));
            document.getElementById('delete-task-detail-btn').addEventListener('click', () => confirmDelete('task', task.id));
            document.getElementById('detail-task-status').addEventListener('change', (e) => handleStatusChange(task.id, e.target.value));
            document.getElementById('suggest-subtasks-btn').addEventListener('click', () => handleSuggestSubtasks(task));
        }

        // --- Task/Project Element Creation ---
        function createTaskElement(task) {
            const isCompleted = task.status === 'done';
            const priorityColors = { low: 'bg-green-500', medium: 'bg-yellow-500', high: 'bg-red-500' };
            const project = appState.projects.find(p => p.id === task.projectId);

            return `
            <div class="task-item flex items-center bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow" data-task-id="${task.id}">
                <button class="task-checkbox flex-shrink-0 h-6 w-6 rounded-full border-2 ${isCompleted ? 'border-indigo-600 bg-indigo-600' : 'border-slate-300 dark:border-slate-600'} flex items-center justify-center transition-all mr-4">
                    ${isCompleted ? '<svg class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </button>
                <div class="flex-grow">
                    <p class="font-medium ${isCompleted ? 'line-through text-slate-500 dark:text-slate-400' : ''}">${task.title}</p>
                    <div class="text-xs text-slate-400 dark:text-slate-500 flex items-center space-x-2 mt-1">
                        ${task.dueDate ? `<span>${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                        ${task.dueDate && project ? '<span>&middot;</span>' : ''}
                        ${project ? `<span>${project.name}</span>` : ''}
                    </div>
                </div>
                <div class="w-2 h-2 rounded-full ${priorityColors[task.priority]} ml-4"></div>
            </div>
            `;
        }
        
        function createTaskCardElement(task) {
            const priorityBorder = { low: 'border-green-500', medium: 'border-yellow-500', high: 'border-red-500' };
            const project = appState.projects.find(p => p.id === task.projectId);

            return `
            <div class="task-card bg-white dark:bg-slate-700 p-3 rounded-md shadow-sm border-l-4 ${priorityBorder[task.priority]} cursor-grab" draggable="true" data-task-id="${task.id}">
                <p class="font-medium text-sm">${task.title}</p>
                 <p class="text-xs text-slate-400 mt-2">${project ? project.name : 'No Project'}</p>
            </div>
            `;
        }

        // --- Event Handlers & Logic ---
        function handleThemeToggle() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        function setupInitialTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        function openModal(modal) {
            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
        }
        
        function showLoader() {
            loaderOverlay.classList.add('flex');
            loaderOverlay.classList.remove('hidden');
        }
        
        function hideLoader() {
            loaderOverlay.classList.add('hidden');
            loaderOverlay.classList.remove('flex');
        }

        function openTaskModal(taskToEdit = null) {
            taskForm.reset();
            const modalTitle = document.getElementById('task-modal-title');
            const taskIdInput = document.getElementById('task-id');
            renderTaskProjectDropdown();

            if (taskToEdit) {
                modalTitle.textContent = 'Edit Task';
                taskIdInput.value = taskToEdit.id;
                document.getElementById('task-title').value = taskToEdit.title;
                document.getElementById('task-description').value = taskToEdit.description || '';
                document.getElementById('task-project').value = taskToEdit.projectId || '';
                document.getElementById('task-priority').value = taskToEdit.priority;
                document.getElementById('task-due-date').value = taskToEdit.dueDate ? new Date(taskToEdit.dueDate).toISOString().split('T')[0] : '';
            } else {
                modalTitle.textContent = 'New Task';
                taskIdInput.value = '';
                // Pre-select project if in a project view
                if (appState.currentFilter.type === 'project') {
                    document.getElementById('task-project').value = appState.currentFilter.id;
                }
            }
            openModal(taskModal);
        }
        
        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            const taskId = document.getElementById('task-id').value;
            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                projectId: document.getElementById('task-project').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value,
                userId: appState.userId,
            };

            try {
                if (taskId) {
                    const taskRef = doc(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`, taskId);
                    await updateDoc(taskRef, taskData);
                } else {
                    taskData.status = 'todo'; // Default status for new tasks
                    taskData.createdAt = new Date().toISOString();
                    const collectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`);
                    await addDoc(collectionRef, taskData);
                }
            } catch (error) {
                console.error("Error saving task:", error);
            }
            
            closeModal(taskModal);
        }

        async function handleSmartAddFormSubmit(e) {
            e.preventDefault();
            const userGoal = document.getElementById('smart-add-prompt').value;
            if (!userGoal) return;

            const systemPrompt = "You are an expert project manager. Your task is to break down a user's high-level goal into a new project with a clear, actionable to-do list. The project name should be concise and relevant to the goal.";
            const userPrompt = `Break down the following goal: "${userGoal}". Respond with a single, minified JSON object with two keys: "projectName" (a string) and "tasks" (an array of strings representing task titles). Do not include any other text or markdown formatting in your response.`;

            const result = await callGeminiAPI(systemPrompt, userPrompt);
            
            if (result && result.projectName && Array.isArray(result.tasks)) {
                try {
                    // 1. Create the project
                    const projectCollectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.userId}/projects`);
                    const projectDocRef = await addDoc(projectCollectionRef, { name: result.projectName, userId: appState.userId });
                    const newProjectId = projectDocRef.id;

                    // 2. Create tasks in a batch
                    const batch = writeBatch(appState.db);
                    const taskCollectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`);
                    result.tasks.forEach(taskTitle => {
                        const newTaskDocRef = doc(taskCollectionRef); // Create a new doc with a generated ID
                        batch.set(newTaskDocRef, {
                            title: taskTitle,
                            description: '',
                            projectId: newProjectId,
                            priority: 'medium',
                            dueDate: '',
                            status: 'todo',
                            createdAt: new Date().toISOString(),
                            userId: appState.userId
                        });
                    });
                    await batch.commit();
                    
                    closeModal(smartAddModal);
                    setFilter('project', newProjectId); // Switch view to the new project

                } catch (error) {
                    console.error("Error creating project and tasks from AI response:", error);
                }
            } else {
                 console.error("AI response was not in the expected format.", result);
                 // Optionally show an error to the user
            }
        }

        async function handleSuggestSubtasks(task) {
            const suggestionsContainer = document.getElementById('subtask-suggestions');
            suggestionsContainer.innerHTML = `<div class="text-sm text-slate-500">Generating suggestions...</div>`;

            const systemPrompt = "You are a productivity assistant. Your task is to suggest the next logical steps for a given to-do item.";
            const userPrompt = `Given the task with title "${task.title}" and description "${task.description}", what are the next 3 actionable steps to complete it? Respond with a single, minified JSON object with one key: "suggestions" (an array of strings). Do not include any other text or markdown formatting in your response.`;
            
            const result = await callGeminiAPI(systemPrompt, userPrompt);

            if (result && result.suggestions && Array.isArray(result.suggestions)) {
                suggestionsContainer.innerHTML = result.suggestions.map(suggestion => `
                    <div class="flex items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded-md">
                        <p class="text-sm flex-grow mr-2">${suggestion}</p>
                        <button class="add-suggested-task-btn p-1 rounded-full bg-indigo-500 hover:bg-indigo-600 text-white flex-shrink-0" data-title="${suggestion}" data-project-id="${task.projectId || ''}">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        </button>
                    </div>
                `).join('');
            } else {
                suggestionsContainer.innerHTML = `<div class="text-sm text-red-500">Could not generate suggestions.</div>`;
            }
        }
        
        async function handleAddSuggestedTask(title, projectId) {
            try {
                const collectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`);
                await addDoc(collectionRef, {
                    title: title,
                    description: '',
                    projectId: projectId,
                    priority: 'medium',
                    dueDate: '',
                    status: 'todo',
                    createdAt: new Date().toISOString(),
                    userId: appState.userId
                });
            } catch (error) {
                console.error("Error adding suggested task:", error);
            }
        }


        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            const projectName = document.getElementById('project-name').value;
            if (projectName) {
                 try {
                    const collectionRef = collection(appState.db, `artifacts/${appId}/users/${appState.userId}/projects`);
                    await addDoc(collectionRef, { name: projectName, userId: appState.userId });
                } catch (error) {
                    console.error("Error adding project:", error);
                }
                closeModal(projectModal);
            }
        }

        async function handleTaskCheckboxClick(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                const newStatus = task.status === 'done' ? 'todo' : 'done';
                try {
                    const taskRef = doc(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`, taskId);
                    await updateDoc(taskRef, { status: newStatus });
                } catch (error) {
                    console.error("Error updating task status:", error);
                }
            }
        }
        
        async function handleStatusChange(taskId, newStatus) {
            const task = appState.tasks.find(t => t.id === taskId);
            if(task && task.status !== newStatus) {
                 try {
                    const taskRef = doc(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`, taskId);
                    await updateDoc(taskRef, { status: newStatus });
                } catch (error) {
                    console.error("Error updating task status from detail panel:", error);
                }
            }
        }

        function confirmDelete(type, id) {
            openModal(confirmModal);
            const title = document.getElementById('confirm-title');
            const message = document.getElementById('confirm-message');
            
            title.textContent = `Delete ${type}?`;
            message.textContent = `Are you sure you want to delete this ${type}? This action cannot be undone.`;
            
            const deleteBtn = document.getElementById('confirm-delete-btn');
            const newDeleteBtn = deleteBtn.cloneNode(true); // Prevent multiple listeners
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            
            newDeleteBtn.addEventListener('click', async () => {
                if (type === 'task') {
                    try {
                        await deleteDoc(doc(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`, id));
                        closeTaskDetailPanel();
                    } catch (error) { console.error("Error deleting task:", error); }
                } else if (type === 'project') {
                    try {
                        // Optional: Also delete all tasks associated with this project. For simplicity, we'll just delete the project for now.
                        await deleteDoc(doc(appState.db, `artifacts/${appId}/users/${appState.userId}/projects`, id));
                        // If current view is this project, switch to today view
                        if (appState.currentFilter.type === 'project' && appState.currentFilter.id === id) {
                            setFilter('today');
                        }
                    } catch (error) { console.error("Error deleting project:", error); }
                }
                closeModal(confirmModal);
            });
        }
        
        function getFilteredTasks() {
            const { type, id } = appState.currentFilter;
            if (type === 'today') {
                const today = new Date().toISOString().split('T')[0];
                return appState.tasks.filter(t => t.dueDate && new Date(t.dueDate).toISOString().split('T')[0] === today);
            } else if (type === 'project') {
                return appState.tasks.filter(t => t.projectId === id);
            }
            return appState.tasks; // Fallback
        }

        function setFilter(type, id = null) {
            appState.currentFilter = { type, id };
            const viewTitle = document.getElementById('view-title');
            if (type === 'today') {
                viewTitle.textContent = 'Today';
            } else if (type === 'project') {
                const project = appState.projects.find(p => p.id === id);
                viewTitle.textContent = project ? project.name : 'Project';
            }
            render();
        }
        
        function openTaskDetailPanel(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                appState.activeTask = task;
                renderTaskDetail(task);
                taskDetailPanel.classList.remove('translate-x-full');
            }
        }
        
        function closeTaskDetailPanel() {
            appState.activeTask = null;
            taskDetailPanel.classList.add('translate-x-full');
        }

        // --- Drag and Drop ---
        let draggedItem = null;

        function addDragAndDropListeners() {
            document.querySelectorAll('.task-card').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('click', () => openTaskDetailPanel(item.dataset.taskId));
            });
            document.querySelectorAll('.task-list').forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.target;
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('task-list')) {
                e.target.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.classList.contains('task-list')) {
                e.target.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const column = e.target.closest('.task-list');
            if (column && draggedItem) {
                column.classList.remove('drag-over');
                const newStatus = column.dataset.status;
                const taskId = draggedItem.dataset.taskId;
                
                const task = appState.tasks.find(t => t.id === taskId);
                if (task && task.status !== newStatus) {
                    try {
                        const taskRef = doc(appState.db, `artifacts/${appId}/users/${appState.userId}/tasks`, taskId);
                        await updateDoc(taskRef, { status: newStatus });
                    } catch (error) {
                        console.error("Error updating task status on drop:", error);
                    }
                }
            }
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            themeToggle.addEventListener('click', handleThemeToggle);
            
            document.getElementById('add-task-main-btn').addEventListener('click', () => openTaskModal());
            document.getElementById('cancel-task-btn').addEventListener('click', () => closeModal(taskModal));
            taskForm.addEventListener('submit', handleTaskFormSubmit);

            document.getElementById('smart-add-btn').addEventListener('click', () => openModal(smartAddModal));
            document.getElementById('cancel-smart-add-btn').addEventListener('click', () => closeModal(smartAddModal));
            smartAddForm.addEventListener('submit', handleSmartAddFormSubmit);
            
            document.getElementById('add-project-btn').addEventListener('click', () => openModal(projectModal));
            document.getElementById('cancel-project-btn').addEventListener('click', () => closeModal(projectModal));
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal(confirmModal));
            
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
            
            // View switcher
            document.querySelector('#view-switcher').addEventListener('click', (e) => {
                if (e.target.matches('.view-btn')) {
                    appState.currentView = e.target.dataset.view;
                    render();
                }
            });
            
            // Navigation clicks
            document.querySelector('#sidebar nav').addEventListener('click', e => {
                const navLink = e.target.closest('a');
                if (!navLink) return;
                
                e.preventDefault();
                
                if(navLink.id === 'nav-today') {
                    setFilter('today');
                } else if(navLink.classList.contains('project-nav-link')) {
                    const projectId = navLink.closest('.project-item-container').dataset.projectId;
                    setFilter('project', projectId);
                }

                if (window.innerWidth < 640) { // sm breakpoint
                    sidebar.classList.add('-translate-x-full');
                }
            });
            
            // Task list clicks
            document.getElementById('task-views-container').addEventListener('click', e => {
                 const checkbox = e.target.closest('.task-checkbox');
                 if (checkbox) {
                    const taskId = checkbox.closest('.task-item').dataset.taskId;
                    handleTaskCheckboxClick(taskId);
                    return; // Prevent opening detail panel
                 }
                
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    openTaskDetailPanel(taskItem.dataset.taskId);
                }
            });
            
            // Project delete clicks
            document.getElementById('project-list').addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-project-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const projectId = deleteBtn.closest('.project-item-container').dataset.projectId;
                    confirmDelete('project', projectId);
                }
            });
            
            // Add suggested task click
            taskDetailPanel.addEventListener('click', e => {
                const addBtn = e.target.closest('.add-suggested-task-btn');
                if (addBtn) {
                    const { title, projectId } = addBtn.dataset;
                    handleAddSuggestedTask(title, projectId);
                    // Provide visual feedback
                    addBtn.innerHTML = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    addBtn.disabled = true;
                    setTimeout(() => addBtn.closest('.flex').remove(), 1000);
                }
            });

        }
        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupInitialTheme();
            setupEventListeners();
            initializeFirebase();
        });

    </script>
</body>
</html>

